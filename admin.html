<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaRich Admin System</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .animate-marquee { display: inline-block; white-space: nowrap; animation: marquee 30s linear infinite; }
        .marquee-container:hover .animate-marquee { animation-play-state: paused; }

        /* ìˆ«ì ì…ë ¥ í™”ì‚´í‘œ ì œê±° */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Placeholder ìŠ¤íƒ€ì¼ */
        input::placeholder { color: #9ca3af; opacity: 1; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">
    <div id="root"></div>

    <!-- [Safety Net] ì „ì—­ ì—ëŸ¬ í•¸ë“¤ëŸ¬ -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            console.error("Global Error Caught:", error);
            const root = document.getElementById('root');
            if (root && (!root.hasChildNodes() || root.innerHTML === "")) {
                root.innerHTML = `
                    <div style="display:flex; justify-content:center; align-items:center; height:100vh; background:#f8fafc; color:#ef4444; flex-direction:column; text-align:center; padding:20px;">
                        <h2 style="font-size:1.5rem; font-weight:bold; margin-bottom:10px;">âš ï¸ ì‹œìŠ¤í…œ ë Œë”ë§ ì˜¤ë¥˜</h2>
                        <p style="margin-bottom:10px; font-family:monospace;">${message}</p>
                        <p style="font-size:0.8rem; color:#64748b;">Line: ${lineno}</p>
                        <button onclick="location.reload()" style="margin-top:20px; padding:10px 20px; background:#3b82f6; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">ìƒˆë¡œê³ ì¹¨</button>
                    </div>
                `;
            }
        };
    </script>

    <script type="text/babel">
        // [Configuration] API URL
        const API_URL = "https://script.google.com/macros/s/AKfycbzccHjG1vZP_M9lW4oOlAsLSkvRZRlYFsDb-mUrvuVEbcNHzBpLedr-X3VBS_CJk9Zf/exec"; 

        // ----------------------------------------------------------------------
        // [System Core] ì•„ì´ì½˜ ë°ì´í„°
        // ----------------------------------------------------------------------
        const IconPaths = {
            user: <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2 M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8"/>,
            lock: <path d="M19 11H5a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2zm-7 0V7a5 5 0 0 1 10 0v4"/>,
            database: <g><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></g>,
            clock: <g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></g>,
            dashboard: <g><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></g>,
            search: <g><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></g>,
            filter: <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>,
            edit: <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7 M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>,
            plus: <g><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></g>,
            save: <g><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></g>,
            refresh: <g><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></g>,
            x: <g><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></g>,
            logout: <g><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></g>,
            trash: <g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></g>,
            settings: <g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></g>,
            userplus: <g><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></g>,
            shield: <g><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></g>,
            rotate: <g><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></g>,
            alert: <g><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></g>,
            trend: <g><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></g>,
            card: <g><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></g>,
            wallet: <g><path d="M20 12V8H6a2 2 0 0 1-2-2c0-1.1.9-2 2-2h12v4"/><path d="M4 6v12a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-6.618a2 2 0 0 0-1.11-1.788L4.17 6.447A1 1 0 0 1 4 6z"/></g>,
            tag: <g><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></g>,
            down: <polyline points="6 9 12 15 18 9"/>,
            left: <polyline points="15 18 9 12 15 6"/>,
            right: <polyline points="9 18 15 12 9 6"/>,
            clipboard: <g><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/><path d="m9 14 2 2 4-4"/></g>,
            zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>,
            pause: <g><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></g>,
            play: <polygon points="5 3 19 12 5 21 5 3"/>,
            bell: <g><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></g>,
            toggleon: <g><rect x="1" y="5" width="22" height="14" rx="7" ry="7" fill="#10B981"/><circle cx="16" cy="12" r="3" fill="white"/></g>,
            toggleoff: <g><rect x="1" y="5" width="22" height="14" rx="7" ry="7" fill="#E2E8F0"/><circle cx="8" cy="12" r="3" fill="white"/></g>,
            usercog: <g><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M19 11a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"/></g>,
            briefcase: <g><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></g>,
            users2: <g><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
            chevrondown: <polyline points="6 9 12 15 18 9"/> 
        };

        const Icon = ({ name, size = 18, className, onClick }) => {
            const pathData = IconPaths[name.toLowerCase()];
            if (!pathData) return null;
            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke="currentColor" 
                    strokeWidth="2" 
                    strokeLinecap="round" 
                    strokeLinejoin="round" 
                    className={className}
                    onClick={onClick}
                    style={{ cursor: onClick ? 'pointer' : 'inherit' }}
                >
                    {pathData}
                </svg>
            );
        };

        // ----------------------------------------------------------------------
        // [Utility Components]
        // ----------------------------------------------------------------------
        const Badge = ({ date }) => {
            if (!date) return null;
            const diffDays = Math.floor((new Date() - new Date(date)) / (1000 * 60 * 60 * 24));
            if (diffDays <= 0) return <span className="ml-2 px-1.5 py-0.5 rounded text-[9px] bg-rose-500 text-white font-black animate-pulse">NEW</span>;
            if (diffDays === 1) return <span className="ml-2 px-1.5 py-0.5 rounded text-[9px] bg-orange-500 text-white font-bold">1ì¼ì „</span>;
            if (diffDays === 2) return <span className="ml-2 px-1.5 py-0.5 rounded text-[9px] bg-amber-500 text-white font-bold">2ì¼ì „</span>;
            return null;
        };

        const REGIONS_DATA = {
            'ì„œìš¸': ['ê°•ë‚¨êµ¬','ê°•ë™êµ¬','ê°•ë¶êµ¬','ê°•ì„œêµ¬','ê´€ì•…êµ¬','ê´‘ì§„êµ¬','êµ¬ë¡œêµ¬','ê¸ˆì²œêµ¬','ë…¸ì›êµ¬','ë„ë´‰êµ¬','ë™ëŒ€ë¬¸êµ¬','ë™ì‘êµ¬','ë§ˆí¬êµ¬','ì„œëŒ€ë¬¸êµ¬','ì„œì´ˆêµ¬','ì„±ë™êµ¬','ì„±ë¶êµ¬','ì†¡íŒŒêµ¬','ì–‘ì²œêµ¬','ì˜ë“±í¬êµ¬','ìš©ì‚°êµ¬','ì€í‰êµ¬','ì¢…ë¡œêµ¬','ì¤‘êµ¬','ì¤‘ë‘êµ¬'],
            'ê²½ê¸°': ['ìˆ˜ì›ì‹œ','ì„±ë‚¨ì‹œ','ì˜ì •ë¶€ì‹œ','ì•ˆì–‘ì‹œ','ë¶€ì²œì‹œ','ê´‘ëª…ì‹œ','í‰íƒì‹œ','ë™ë‘ì²œì‹œ','ì•ˆì‚°ì‹œ','ê³ ì–‘ì‹œ','ê³¼ì²œì‹œ','êµ¬ë¦¬ì‹œ','ë‚¨ì–‘ì£¼ì‹œ','ì˜¤ì‚°ì‹œ','ì‹œí¥ì‹œ','êµ°í¬ì‹œ','ì˜ì™•ì‹œ','í•˜ë‚¨ì‹œ','ìš©ì¸ì‹œ','íŒŒì£¼ì‹œ','ì´ì²œì‹œ','ì•ˆì„±ì‹œ','ê¹€í¬ì‹œ','í™”ì„±ì‹œ','ê´‘ì£¼ì‹œ','ì–‘ì£¼ì‹œ','í¬ì²œì‹œ','ì—¬ì£¼ì‹œ','ì—°ì²œêµ°','ê°€í‰êµ°','ì–‘í‰êµ°'],
            'ë¶€ì‚°': ['ì¤‘êµ¬','ì„œêµ¬','ë™êµ¬','ì˜ë„êµ¬','ë¶€ì‚°ì§„êµ¬','ë™ë˜êµ¬','ë‚¨êµ¬','ë¶êµ¬','í•´ìš´ëŒ€êµ¬','ì‚¬í•˜êµ¬','ê¸ˆì •êµ¬','ê°•ì„œêµ¬','ì—°ì œêµ¬','ìˆ˜ì˜êµ¬','ì‚¬ìƒêµ¬','ê¸°ì¥êµ°'],
            'ëŒ€êµ¬': ['ì¤‘êµ¬','ë™êµ¬','ì„œêµ¬','ë‚¨êµ¬','ë¶êµ¬','ìˆ˜ì„±êµ¬','ë‹¬ì„œêµ¬','ë‹¬ì„±êµ°'],
            'ì¸ì²œ': ['ì¤‘êµ¬','ë™êµ¬','ë¯¸ì¶”í™€êµ¬','ì—°ìˆ˜êµ¬','ë‚¨ë™êµ¬','ë¶€í‰êµ¬','ê³„ì–‘êµ¬','ì„œêµ¬','ê°•í™”êµ°','ì˜¹ì§„êµ°'],
            'ê´‘ì£¼': ['ë™êµ¬','ì„œêµ¬','ë‚¨êµ¬','ë¶êµ¬','ê´‘ì‚°êµ¬'],
            'ëŒ€ì „': ['ë™êµ¬','ì¤‘êµ¬','ì„œêµ¬','ìœ ì„±êµ¬','ëŒ€ë•êµ¬'],
            'ìš¸ì‚°': ['ì¤‘êµ¬','ë‚¨êµ¬','ë™êµ¬','ë¶êµ¬','ìš¸ì£¼êµ°'],
            'ì„¸ì¢…': ['ì„¸ì¢…ì‹œ'],
            'ê°•ì›': ['ì¶˜ì²œì‹œ','ì›ì£¼ì‹œ','ê°•ë¦‰ì‹œ','ë™í•´ì‹œ','íƒœë°±ì‹œ','ì†ì´ˆì‹œ','ì‚¼ì²™ì‹œ','í™ì²œêµ°','íš¡ì„±êµ°','ì˜ì›”êµ°','í‰ì°½êµ°','ì •ì„ êµ°','ì² ì›êµ°','í™”ì²œêµ°','ì–‘êµ¬êµ°','ì¸ì œêµ°','ê³ ì„±êµ°','ì–‘ì–‘êµ°'],
            'ì¶©ë¶': ['ì²­ì£¼ì‹œ','ì¶©ì£¼ì‹œ','ì œì²œì‹œ','ë³´ì€êµ°','ì˜¥ì²œêµ°','ì˜ë™êµ°','ì¦í‰êµ°','ì§„ì²œêµ°','ê´´ì‚°êµ°','ìŒì„±êµ°','ë‹¨ì–‘êµ°'],
            'ì¶©ë‚¨': ['ì²œì•ˆì‹œ','ê³µì£¼ì‹œ','ë³´ë ¹ì‹œ','ì•„ì‚°ì‹œ','ì„œì‚°ì‹œ','ë…¼ì‚°ì‹œ','ê³„ë£¡ì‹œ','ë‹¹ì§„ì‹œ','ê¸ˆì‚°êµ°','ë¶€ì—¬êµ°','ì„œì²œêµ°','ì²­ì–‘êµ°','í™ì„±êµ°','ì˜ˆì‚°êµ°','íƒœì•ˆêµ°'],
            'ì „ë¶': ['ì „ì£¼ì‹œ','êµ°ì‚°ì‹œ','ìµì‚°ì‹œ','ì •ìì‹œ','ë‚¨ì›ì‹œ','ê¹€ì œì‹œ','ì™„ì£¼êµ°','ì§„ì•ˆêµ°','ë¬´ì£¼êµ°','ì¥ìˆ˜êµ°','ì„ì‹¤êµ°','ìˆœì°½êµ°','ê³ ì°½êµ°','ë¶€ì•ˆêµ°'],
            'ì „ë‚¨': ['ëª©í¬ì‹œ','ì—¬ìˆ˜ì‹œ','ìˆœì²œì‹œ','ë‚˜ì£¼ì‹œ','ê´‘ì–‘ì‹œ','ë‹´ì–‘êµ°','ê³¡ì„±êµ°','êµ¬ë¡€êµ°','ê³ í¥êµ°','ë³´ì„±êµ°','í™”ìˆœêµ°','ì¥í¥êµ°','ê°•ì§„êµ°','í•´ë‚¨êµ°','ì˜ì•”êµ°','ë¬´ì•ˆêµ°','í•¨í‰êµ°','ì˜ê´‘êµ°','ì¥ì„±êµ°','ì™„ë„êµ°','ì§„ë„êµ°','ì‹ ì•ˆêµ°'],
            'ê²½ë¶': ['í¬í•­ì‹œ','ê²½ì£¼ì‹œ','ê¹€ì²œì‹œ','ì•ˆë™ì‹œ','êµ¬ë¯¸ì‹œ','ì˜ì£¼ì‹œ','ì˜ì²œì‹œ','ìƒì£¼ì‹œ','ë¬¸ê²½ì‹œ','ê²½ì‚°ì‹œ','ì˜ì„±êµ°','ì²­ì†¡êµ°','ì˜ì–‘êµ°','ì˜ë•êµ°','ì²­ë„êµ°','ê³ ë ¹êµ°','ì„±ì£¼êµ°','ì¹ ê³¡êµ°','ì˜ˆì²œêµ°','ë´‰í™”êµ°','ìš¸ì§„êµ°','ìš¸ë¦‰êµ°'],
            'ê²½ë‚¨': ['ì°½ì›ì‹œ','ì§„ì£¼ì‹œ','í†µì˜ì‹œ','ì‚¬ì²œì‹œ','ê¹€í•´ì‹œ','ë°€ì–‘ì‹œ','ê±°ì œì‹œ','ì–‘ì‚°ì‹œ','ì˜ë ¹êµ°','í•¨ì•ˆêµ°','ì°½ë…•êµ°','ê³ ì„±êµ°','ë‚¨í•´êµ°','í•˜ë™êµ°','ì‚°ì²­êµ°','í•¨ì–‘êµ°','ê±°ì°½êµ°','í•©ì²œêµ°'],
            'ì œì£¼': ['ì œì£¼ì‹œ','ì„œê·€í¬ì‹œ']
        };

        // ----------------------------------------------------------------------
        // [View Components] 
        // ----------------------------------------------------------------------

        // 1. ë¡œê·¸ì¸ ë·°
        const LoginView = ({ onLogin, loading }) => {
            // [ìˆ˜ì •] ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°ê°’ì„ ë¹ˆ ë¬¸ìì—´ë¡œ ë³€ê²½
            const [inputId, setInputId] = React.useState('');
            const [inputPw, setInputPw] = React.useState('');
            const handleKeyDown = (e) => { if (e.key === 'Enter') onLogin(inputId, inputPw); };

            return (
                <div className="flex-1 flex items-center justify-center min-h-screen bg-slate-100 fade-in">
                    <div className="w-full max-w-sm p-10 bg-white border border-slate-200 rounded-2xl shadow-xl">
                        <div className="mb-10 text-center">
                            <h1 className="text-3xl font-black italic uppercase text-slate-900">Meta Admin</h1>
                            <p className="text-[10px] text-slate-400 mt-2 font-bold tracking-[0.3em] uppercase">System Access v20.3</p>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase ml-1">ID (Admin)</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-3.5 text-slate-400"><Icon name="user" size={16}/></span>
                                    <input 
                                        className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                                        placeholder="ì•„ì´ë”” ì…ë ¥" 
                                        value={inputId} 
                                        onChange={e=>setInputId(e.target.value)} 
                                        onKeyDown={handleKeyDown}
                                        autoFocus
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="text-[10px] font-black text-slate-400 uppercase ml-1">Password</label>
                                <div className="relative">
                                    <span className="absolute left-3 top-3.5 text-slate-400"><Icon name="lock" size={16}/></span>
                                    <input 
                                        className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold outline-none focus:ring-2 focus:ring-blue-500 transition-colors"
                                        type="password" 
                                        placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" 
                                        value={inputPw} 
                                        onChange={e=>setInputPw(e.target.value)} 
                                        onKeyDown={handleKeyDown}
                                    />
                                </div>
                            </div>
                            <button 
                                onClick={()=>onLogin(inputId, inputPw)} 
                                disabled={loading}
                                className="w-full py-4 bg-slate-900 text-white rounded-xl text-xs font-black uppercase mt-4 hover:bg-black transition-all shadow-lg flex justify-center items-center gap-2"
                            >
                                {loading && <Icon name="refresh" size={14} className="animate-spin"/>}
                                <span>{loading ? "Verifying..." : "System Login"}</span>
                            </button>
                        </div>
                        {!API_URL && <p className="mt-6 text-[10px] text-center text-blue-600 bg-blue-50 p-2 rounded font-bold">ğŸ’¡ ìµœê³  ê´€ë¦¬ì: partners / partners1!</p>}
                    </div>
                </div>
            );
        };

        // 2. ëŒ€ì‹œë³´ë“œ
        const DashboardView = ({ masterDB, returnRequests }) => {
            const stats = [
                { l: 'ì´ DB ìì‚°', v: (masterDB||[]).length, icon: 'database', color: 'text-blue-600' },
                { l: 'ë¯¸ë°°ì • DB', v: (masterDB||[]).filter(d => d.status === 'ë¯¸ë°°ì •').length, icon: 'alert', color: 'text-rose-500' },
                { l: 'ë°˜í’ˆ ìš”ì²­', v: (returnRequests||[]).length, icon: 'rotate', color: 'text-amber-500' },
                { l: 'ê¸ˆì›” ë§¤ì¶œ', v: 'â‚© 125M', icon: 'trend', color: 'text-emerald-600' }
            ];
            return (
                <div className="space-y-6 fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        {stats.map((s, i) => (
                            <div key={i} className="p-6 bg-white border border-slate-200 rounded-xl shadow-sm flex items-center justify-between">
                                <div><p className="text-[10px] text-slate-400 uppercase font-black tracking-widest">{s.l}</p><p className={`text-2xl font-black mt-2 ${s.color}`}>{s.v}</p></div>
                                <div className="text-slate-200 text-3xl"><Icon name={s.icon} size={32}/></div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // 3. DB í†µí•© ê´€ë¦¬
        const DBManageView = ({ masterDB, partners, branches, dbTypes, onAssign, applyRequests }) => {
            const [inputs, setInputs] = React.useState({ branch: 'ì „ì²´', type: 'ì „ì²´', search: '', startDate: '', endDate: '' });
            const [filters, setFilters] = React.useState(inputs);
            const [selectedDB, setSelectedDB] = React.useState(null);
            const [sortOrder, setSortOrder] = React.useState('desc');

            const handleSearch = () => { setFilters(inputs); };

            const totalRequested = (applyRequests||[]).reduce((acc, cur) => acc + parseInt(cur.qty || 0), 0);
            const today = new Date().toISOString().slice(0, 10);
            const todayRequests = (applyRequests||[]).filter(req => req.date && req.date.startsWith(today)).length;
            const assignedCount = (masterDB||[]).filter(d => d.status === 'ë°°ì •ì™„ë£Œ').length;
            const unassignedCount = (masterDB||[]).filter(d => d.status === 'ë¯¸ë°°ì •').length;

            const statsByType = React.useMemo(() => {
                const stats = {};
                (masterDB||[]).forEach(d => { stats[d.type] = (stats[d.type] || 0) + 1; });
                return stats;
            }, [masterDB]);

            const allTypes = [...new Set([...(dbTypes||[]).map(t=>t.name), ...Object.keys(statsByType)])];

            const filteredDB = (masterDB||[]).filter(d => {
                const dbDate = new Date(d.regDate);
                const start = filters.startDate ? new Date(filters.startDate) : null;
                const end = filters.endDate ? new Date(filters.endDate) : null;
                if (end) end.setHours(23, 59, 59);

                return (filters.branch === 'ì „ì²´' || (d.partnerTeam || 'ë¯¸ë°°ì •') === filters.branch) &&
                       (filters.type === 'ì „ì²´' || d.type === filters.type) &&
                       (!filters.search || d.customerName.includes(filters.search) || (d.phone && d.phone.includes(filters.search))) &&
                       (!start || dbDate >= start) && (!end || dbDate <= end);
            })
            .sort((a,b) => sortOrder === 'desc' ? new Date(b.regDate) - new Date(a.regDate) : new Date(a.regDate) - new Date(b.regDate));

            const handleManualAssign = (dbId, partnerId) => {
                const partner = partners.find(p => p.employeeId === partnerId);
                const db = masterDB.find(d => d.id === dbId || d.dbId === dbId);
                if (!partner || !db) return;
                const reqQty = (applyRequests||[]).filter(r => r.partnerId === partnerId && r.type === db.type).reduce((a,c)=>a+Number(c.qty), 0);
                const assignedQty = (masterDB||[]).filter(d => d.partnerId === partnerId && d.type === db.type).length;
                if (assignedQty >= reqQty) {
                    if (!confirm(`${partner.name}ë‹˜ì€ '${db.type}' ì‹ ì²­ ìˆ˜ëŸ‰ì„ ì´ë¯¸ ì¶©ì¡±í–ˆìŠµë‹ˆë‹¤.\nê³„ì† ë°°ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
                }
                onAssign(dbId, partnerId);
            };

            const tickerItems = React.useMemo(() => {
                return (applyRequests||[]).slice(0, 10).map(req => {
                    const partner = partners.find(p => p.employeeId === req.partnerId);
                    return { ...req, team: partner ? partner.team : 'ì§€ì ë¯¸ìƒ', partnerName: partner ? partner.name : req.partnerName };
                });
            }, [applyRequests, partners]);

            return (
                <div className="space-y-4 fade-in">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="p-4 bg-white border border-slate-200 rounded-xl shadow-sm"><p className="text-[10px] font-black text-slate-400 uppercase">ì‹ ì²­DB ì´í•©</p><p className="text-2xl font-black text-blue-600 mt-1">{totalRequested}ê±´</p></div>
                        <div className="p-4 bg-white border border-slate-200 rounded-xl shadow-sm"><p className="text-[10px] font-black text-slate-400 uppercase">ê¸ˆì¼ ì‹ ê·œ ì‹ ì²­</p><p className="text-2xl font-black text-rose-500 mt-1">{todayRequests}ê±´</p></div>
                        <div className="p-4 bg-white border border-slate-200 rounded-xl shadow-sm"><p className="text-[10px] font-black text-slate-400 uppercase">ë°°ì • ì™„ë£Œ</p><p className="text-2xl font-black text-emerald-600 mt-1">{assignedCount}ê±´</p></div>
                        <div className="p-4 bg-white border border-slate-200 rounded-xl shadow-sm"><p className="text-[10px] font-black text-slate-400 uppercase">ë¯¸ë°°ì • DB</p><p className="text-2xl font-black text-slate-600 mt-1">{unassignedCount}ê±´</p></div>
                    </div>

                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm space-y-4">
                        <div className="flex flex-wrap items-center justify-between gap-3">
                             <div className="flex flex-wrap gap-3 items-end">
                                <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-1 uppercase">ì§€ì  ì„ íƒ</label><select className="p-2 border border-slate-200 rounded-lg text-xs font-bold w-32 outline-none focus:ring-1 focus:ring-blue-500 bg-slate-50 cursor-pointer" value={inputs.branch} onChange={e=>setInputs({...inputs, branch:e.target.value})}><option>ì „ì²´</option><option>ë¯¸ë°°ì •</option>{branches.map(b=><option key={b.branchName}>{b.branchName}</option>)}</select></div>
                                <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-1 uppercase">ë‹¤ì´ë‚˜ë¯¹ ëª©ë¡</label><div className="relative"><select className="w-48 p-2 border border-slate-200 rounded-lg text-xs font-bold outline-none focus:ring-1 focus:ring-blue-500 bg-slate-50 appearance-none cursor-pointer" value={inputs.type} onChange={e=>setInputs({...inputs, type:e.target.value})}><option value="ì „ì²´">ì „ì²´ ë³´ê¸° ({masterDB.length})</option>{allTypes.map(type => (<option key={type} value={type}>{type} ({statsByType[type] || 0})</option>))}</select><span className="absolute right-3 top-2.5 text-slate-400 pointer-events-none"><Icon name="down" size={14}/></span></div></div>
                                <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-1 uppercase">ìœ ì… ê¸°ê°„</label><div className="flex items-center gap-1 bg-slate-50 border border-slate-200 rounded-lg p-1"><input type="date" className="bg-transparent text-xs font-bold outline-none p-1" value={inputs.startDate} onChange={e=>setInputs({...inputs, startDate:e.target.value})} /><span className="text-slate-400 text-xs">~</span><input type="date" className="bg-transparent text-xs font-bold outline-none p-1" value={inputs.endDate} onChange={e=>setInputs({...inputs, endDate:e.target.value})} /></div></div>
                                <div className="space-y-1 min-w-[200px]"><label className="text-[10px] font-black text-slate-400 ml-1 uppercase">í†µí•© ê²€ìƒ‰</label><div className="relative"><span className="absolute left-3 top-2.5 text-slate-400 text-sm"><Icon name="search" size={14}/></span><input className="w-full pl-9 p-2 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold outline-none focus:ring-1 focus:ring-blue-500" placeholder="ê³ ê°ëª…, ì—°ë½ì²˜..." value={inputs.search} onChange={e=>setInputs({...inputs, search:e.target.value})}/></div></div>
                                <button onClick={handleSearch} className="px-6 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-xs font-black shadow-sm h-[38px] flex items-center gap-2 active:scale-95"><Icon name="search" size={14}/> ê²€ìƒ‰ ì ìš©</button>
                             </div>
                             <div className="flex gap-2">
                                <button onClick={()=>setSortOrder('desc')} className={`px-3 py-1 rounded text-xs border font-bold ${sortOrder==='desc'?'bg-slate-900 text-white':'bg-white text-slate-500'}`}>ìµœì‹ ìˆœ</button>
                                <button onClick={()=>setSortOrder('asc')} className={`px-3 py-1 rounded text-xs border font-bold ${sortOrder==='asc'?'bg-slate-900 text-white':'bg-white text-slate-500'}`}>ê³¼ê±°ìˆœ</button>
                             </div>
                        </div>
                    </div>

                    <div className="w-full bg-slate-900 text-white p-2 rounded-lg overflow-hidden flex items-center shadow-inner marquee-container">
                        <span className="text-[10px] font-black bg-rose-600 px-2 py-0.5 rounded mr-3 shrink-0 animate-pulse">LIVE</span>
                        <div className="overflow-hidden w-full"><div className="animate-marquee inline-block whitespace-nowrap text-xs font-bold text-slate-300" style={{fontSize: '0.8rem'}}>{tickerItems.length > 0 ? tickerItems.map((item, idx) => (<span key={idx} className="mr-8"><span className="text-emerald-400">[{item.date}]</span> {item.team} {item.partnerName}ë‹˜, <span className="text-white">{item.type}</span> <span className="text-amber-400">{item.qty}ê±´</span> ì‹ ì²­</span>)) : "ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤."}</div></div>
                    </div>

                    <div className="bg-white border border-slate-200 rounded-xl overflow-hidden shadow-sm">
                        <table className="w-full text-left text-xs font-bold">
                            <thead className="bg-slate-50 text-slate-500 border-b border-slate-200"><tr><th className="p-4 w-1/4">ë“±ë¡ì¼/ìƒíƒœ</th><th className="p-4 w-1/4">ê³ ê°ì •ë³´</th><th className="p-4 w-1/4">ë‹´ë‹¹ì</th><th className="p-4 w-1/4 text-center">ê´€ë¦¬</th></tr></thead>
                            <tbody className="divide-y divide-slate-100 text-slate-700">
                                {filteredDB.map((db, index) => (
                                    <tr key={`${db.dbId}_${index}`} className="hover:bg-slate-50 transition-colors">
                                        <td className="p-4"><div className="font-mono text-slate-400">{db.regDate ? db.regDate.split('T')[0] : '-'}</div><Badge date={db.regDate}/><div className={`mt-1 inline-block px-2 py-0.5 rounded text-[9px] ${db.status==='ë°°ì •ì™„ë£Œ'?'bg-emerald-100 text-emerald-600':'bg-slate-100 text-slate-500'}`}>{db.status}</div></td>
                                        <td className="p-4"><p className="text-slate-800 text-sm">{db.customerName}</p><p className="text-slate-400 text-[10px]">{db.area} | {db.type}</p></td>
                                        <td className="p-4">{db.partnerName ? <span className="text-blue-600">{db.partnerName} <span className="text-slate-400">({db.partnerTeam})</span></span> : <select className="p-1.5 border border-slate-200 rounded bg-white text-slate-400 text-xs w-full max-w-[150px]" onChange={(e)=>handleManualAssign(db.id || db.dbId, e.target.value)}><option value="">ë°°ì • ì„ íƒ</option>{partners.map(p=><option key={p.employeeId} value={p.employeeId}>{p.name} ({(applyRequests||[]).filter(r=>r.partnerId===p.employeeId && r.type===db.type).reduce((a,c)=>a+Number(c.qty),0)}/{(masterDB||[]).filter(d=>d.partnerId===p.employeeId && d.type===db.type).length})</option>)}</select>}</td>
                                        <td className="p-4 text-center"><button onClick={()=>setSelectedDB(db)} className="text-slate-400 hover:text-blue-600"><Icon name="edit" size={16}/></button></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {selectedDB && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white w-full max-w-2xl rounded-xl shadow-2xl overflow-hidden">
                                <div className="bg-slate-900 p-4 flex justify-between items-center text-white"><h3 className="font-black flex items-center gap-2"><Icon name="database" size={16}/> DB ìƒì„¸ ì •ë³´</h3><button onClick={()=>setSelectedDB(null)}><Icon name="x"/></button></div>
                                <div className="p-6 grid grid-cols-2 gap-6 text-sm">
                                    <div className="space-y-4"><h4 className="font-black text-slate-400 border-b pb-2 text-xs uppercase">ê³ ê° ì •ë³´</h4><div className="grid grid-cols-2 gap-4"><div><p className="text-xs text-slate-400">ì´ë¦„</p><p className="font-bold">{selectedDB.customerName}</p></div><div><p className="text-xs text-slate-400">ì—°ë½ì²˜</p><p className="font-bold">{selectedDB.phone}</p></div><div><p className="text-xs text-slate-400">ìƒë…„ì›”ì¼</p><p className="font-bold">{selectedDB.birthYear ? `${selectedDB.birthYear}.${selectedDB.birthMonth}.${selectedDB.birthDay}` : '-'}</p></div><div><p className="text-xs text-slate-400">ì§€ì—­</p><p className="font-bold">{selectedDB.area}</p></div></div></div>
                                    <div className="space-y-4"><h4 className="font-black text-slate-400 border-b pb-2 text-xs uppercase">ìƒë‹´ ë©”ëª¨</h4><div className="h-40 bg-slate-50 p-3 rounded border overflow-y-auto text-xs whitespace-pre-wrap">{selectedDB.memos || "í™œë™ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤."}</div></div>
                                </div>
                                <div className="p-4 bg-slate-50 border-t flex justify-end gap-2"><button onClick={()=>setSelectedDB(null)} className="px-4 py-2 bg-white border rounded hover:bg-slate-100 text-xs font-bold">ë‹«ê¸°</button></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 4. ë°°ì • ê´€ë¦¬
        const AssignmentManageView = ({ applyRequests, masterDB, dbTypes }) => {
            const [filters, setFilters] = React.useState({ startDate: '', endDate: '', name: '', type: 'ì „ì²´' });
            const [selectedRequest, setSelectedRequest] = React.useState(null);

            const filteredRequests = (applyRequests||[]).filter(req => {
                const reqDate = new Date(req.date);
                const start = filters.startDate ? new Date(filters.startDate) : null;
                const end = filters.endDate ? new Date(filters.endDate) : null;
                if(end) end.setHours(23, 59, 59);
                return (filters.type === 'ì „ì²´' || req.type === filters.type) && (!filters.name || req.partnerName.includes(filters.name)) && (!start || reqDate >= start) && (!end || reqDate <= end);
            });

            const getAssignedDBs = (req) => masterDB.filter(db => db.partnerId === req.partnerId && db.type === req.type);

            return (
                <div className="space-y-4 fade-in">
                    <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm space-y-3">
                        <div className="flex justify-between items-center border-b pb-2 mb-2">
                             <h3 className="font-black text-slate-800 flex items-center gap-2"><Icon name="clipboard" size={18}/> ë°°ì • ê´€ë¦¬</h3>
                        </div>
                        <div className="flex flex-wrap gap-3 items-end">
                             <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-1">ê¸°ê°„</label><div className="flex items-center gap-1 bg-slate-50 border rounded p-1"><input type="date" className="bg-transparent text-xs font-bold outline-none" value={filters.startDate} onChange={e=>setFilters({...filters, startDate:e.target.value})} /><span>~</span><input type="date" className="bg-transparent text-xs font-bold outline-none" value={filters.endDate} onChange={e=>setFilters({...filters, endDate:e.target.value})} /></div></div>
                             <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-1">ì˜ì—…ìëª…</label><input className="p-2 border rounded text-xs font-bold w-32 outline-none" placeholder="ì´ë¦„" value={filters.name} onChange={e=>setFilters({...filters, name:e.target.value})} /></div>
                             <div className="space-y-1"><label className="text-[10px] font-black text-slate-400 ml-1">DB ì¢…ë¥˜</label><select className="p-2 border rounded text-xs font-bold w-32 outline-none" value={filters.type} onChange={e=>setFilters({...filters, type:e.target.value})}><option value="ì „ì²´">ì „ì²´</option>{(dbTypes||[]).map(t=><option key={t.code}>{t.name}</option>)}</select></div>
                        </div>
                    </div>

                    <div className="bg-white border rounded-xl overflow-hidden shadow-sm">
                        <table className="w-full text-left text-xs font-bold">
                            <thead className="bg-slate-50 text-slate-500 border-b"><tr><th className="p-4">ì‹ ì²­ì¼ì‹œ</th><th className="p-4">ì˜ì—…ì</th><th className="p-4">ì¢…ë¥˜</th><th className="p-4 text-right">ì‹ ì²­ìˆ˜ëŸ‰</th><th className="p-4 text-right">ì´ ë°°ì •ìˆ˜ëŸ‰</th><th className="p-4 text-right">ë¯¸ë°°ì • ì”ì—¬</th><th className="p-4 text-center">ìƒì„¸</th></tr></thead>
                            <tbody className="divide-y text-slate-700">
                                {filteredRequests.map((req, i) => {
                                    const totalAssigned = masterDB.filter(d => d.partnerId === req.partnerId && d.type === req.type).length;
                                    const partnerTotalReq = (applyRequests||[]).filter(r => r.partnerId === req.partnerId && r.type === req.type).reduce((a,c)=>a+parseInt(c.qty),0);
                                    const remaining = partnerTotalReq - totalAssigned;
                                    return (
                                        <tr key={i} className="hover:bg-slate-50">
                                            <td className="p-4 font-mono text-slate-400">{req.date}</td><td className="p-4">{req.partnerName}</td><td className="p-4"><span className="px-2 py-0.5 bg-slate-100 rounded text-slate-600">{req.type}</span></td><td className="p-4 text-right">{req.qty}</td><td className="p-4 text-right text-blue-600">{totalAssigned} (ëˆ„ì )</td><td className="p-4 text-right text-rose-500">{remaining > 0 ? remaining : 0}</td>
                                            <td className="p-4 text-center"><button onClick={()=>setSelectedRequest(req)} className="text-slate-400 hover:text-blue-600"><Icon name="search" size={16}/></button></td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                    {selectedRequest && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                            <div className="bg-white w-full max-w-4xl rounded-xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                                <div className="bg-slate-900 p-4 flex justify-between items-center text-white shrink-0"><h3 className="font-black flex items-center gap-2"><Icon name="clipboard" size={18}/> ë°°ì • ìƒì„¸ ë‚´ì—­ - {selectedRequest.partnerName} ({selectedRequest.type})</h3><button onClick={()=>setSelectedRequest(null)}><Icon name="x"/></button></div>
                                <div className="p-0 overflow-auto">
                                    <table className="w-full text-left text-xs font-bold"><thead className="bg-slate-100 text-slate-500 border-b sticky top-0"><tr><th className="p-3">ë°°ì •ì¼ì‹œ</th><th className="p-3">ê³ ê°ëª…</th><th className="p-3">ì—°ë½ì²˜</th></tr></thead><tbody className="divide-y text-slate-700">{getAssignedDBs(selectedRequest).map((db,i)=><tr key={i}><td className="p-3 font-mono text-slate-400">{db.regDate}</td><td className="p-3">{db.customerName}</td><td className="p-3">{db.phone}</td></tr>)}</tbody></table>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // 5. ìë™ ë°°ì • ì„¤ì •
        const AutoAssignView = ({ onRunAutoAssign, callApi }) => {
            const [isRunning, setIsRunning] = React.useState(false);
            const [notify, setNotify] = React.useState(true);
            const [unitCount, setUnitCount] = React.useState(''); // [Fix] ë¹ˆ ê°’ ì‹œì‘
            const [logs, setLogs] = React.useState([]);
            const runningRef = React.useRef(false);
            const [ageRules, setAgeRules] = React.useState([{ id: 1, min: '', max: '', type: 'exclude' }]); // [Fix] ë¹ˆ ê°’ ì‹œì‘
            
            const regions = REGIONS_DATA; 
            const [expandedRegion, setExpandedRegion] = React.useState(null);
            const [excludedRegions, setExcludedRegions] = React.useState([]);

            // [New] í˜„ì¬ ì ìš©ëœ ì„¤ì • ìƒíƒœ (ìƒë‹¨ ê²€ì€ ë°•ìŠ¤ í‘œì‹œìš©)
            const [appliedSettings, setAppliedSettings] = React.useState(null);

            // ì´ˆê¸° ë¡œë”© ì‹œ ì„œë²„ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
            React.useEffect(() => {
                const loadSettings = async () => {
                    const res = await callApi('getAutoAssignSettings');
                    if (res.status === 'success' && res.data) {
                        const { isRunning, config } = res.data;
                        setIsRunning(isRunning);
                        if(config) {
                            setUnitCount(config.unitCount);
                            setNotify(config.notify);
                            setAgeRules(config.ageRanges || []);
                            setExcludedRegions(config.regions || []);
                            setAppliedSettings(config); // ë¡œë“œëœ ì„¤ì • í‘œì‹œ
                        }
                    }
                };
                loadSettings();
            }, [callApi]);

            const toggleRegion = (p, d) => {
                const key = `${p}-${d}`;
                setExcludedRegions(prev => prev.includes(key) ? prev.filter(k=>k!==key) : [...prev, key]);
            };
            const toggleAllInRegion = (prov) => {
                const districts = regions[prov];
                const allKeys = districts.map(d => `${prov}-${d}`);
                const isAllSelected = districts.every(d => excludedRegions.includes(`${prov}-${d}`));
                if (isAllSelected) { setExcludedRegions(prev => prev.filter(k => !k.startsWith(`${prov}-`))); } 
                else { setExcludedRegions(prev => { const others = prev.filter(k => !k.startsWith(`${prov}-`)); return [...others, ...allKeys]; }); }
            };

            const addAgeRule = () => setAgeRules([...ageRules, { id: Date.now(), min: '', max: '', type: 'include' }]);
            
            // [Fix] ì ìš© ë²„íŠ¼ í•¸ë“¤ëŸ¬
            const handleApplySettings = () => {
                const newSettings = { unitCount: Number(unitCount)||1, notify, ageRanges: ageRules, regions: excludedRegions };
                setAppliedSettings(newSettings); // ìƒë‹¨ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
                // ì„œë²„ì— ì„¤ì • ì €ì¥ (ì‹¤í–‰ ìƒíƒœëŠ” ìœ ì§€)
                callApi('saveAutoAssignSettings', { config: newSettings });
                alert("ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            // [Fix] ì‹œì‘/ì¤‘ì§€ í•¸ë“¤ëŸ¬ (ì„œë²„ ìƒíƒœ ë™ê¸°í™”)
            const toggleRunning = async () => {
                const nextState = !isRunning;
                setIsRunning(nextState);
                
                // ì„¤ì •ì€ 'ì„¤ì • ì ìš©í•˜ê¸°' ë²„íŠ¼ì„ í†µí•´ì„œë§Œ ì €ì¥ë¨. ì˜¤ì§ ì‹¤í–‰ ìƒíƒœë§Œ ë³€ê²½.
                await callApi('saveAutoAssignSettings', { 
                    isRunning: nextState
                });

                if (nextState) {
                    setLogs(prev => [`[${new Date().toLocaleTimeString()}] ìë™ ë°°ì • ì‹œì‘ë¨`, ...prev]);
                } else {
                    setLogs(prev => [`[${new Date().toLocaleTimeString()}] ìë™ ë°°ì • ì¤‘ì§€ë¨`, ...prev]);
                }
            };
            
            // [New] ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ìƒíƒœ
            const [showDetail, setShowDetail] = React.useState(false);

            return (
                <div className="space-y-6 fade-in">
                    {/* ìƒë‹¨ ê²€ì€ìƒ‰ ìƒíƒœ ë°•ìŠ¤ */}
                    <div className="bg-slate-900 text-white p-6 rounded-xl shadow-lg flex justify-between items-start relative">
                        <div>
                            <h3 className="font-black text-lg mb-2 flex items-center gap-2">
                                <Icon name="zap" className={isRunning ? "text-emerald-400 animate-pulse" : "text-slate-500"}/> 
                                {isRunning ? "ìë™ ë°°ì • ì‹œìŠ¤í…œ ê°€ë™ ì¤‘" : "ì‹œìŠ¤í…œ ëŒ€ê¸° ì¤‘"}
                            </h3>
                            <div className="text-xs text-slate-400 space-y-1">
                                <p>â€¢ 1íšŒì „ ë°°ì •: <span className="text-white font-bold">{appliedSettings?.unitCount || '-'}ê±´</span></p>
                                <p>â€¢ ì œì™¸ ì§€ì—­: <span className="text-white font-bold">{appliedSettings?.regions?.length || 0}ê°œ</span></p>
                                <p>â€¢ ì—°ë ¹ í•„í„°: <span className="text-white font-bold">{appliedSettings?.ageRanges?.length || 0}ê°œ ê·œì¹™</span></p>
                                <p>â€¢ ì•Œë¦¼ ë°œì†¡: <span className={appliedSettings?.notify ? "text-emerald-400" : "text-rose-400"}>{appliedSettings?.notify ? "ON" : "OFF"}</span></p>
                            </div>
                        </div>
                        <div className="flex flex-col items-end gap-2">
                            <button 
                                onClick={toggleRunning} 
                                className={`px-6 py-3 rounded-lg font-black flex items-center gap-2 shadow-lg transition-all ${isRunning ? 'bg-rose-600 hover:bg-rose-700' : 'bg-emerald-600 hover:bg-emerald-700'}`}
                            >
                                {isRunning ? <><Icon name="pause"/> ì¤‘ì§€</> : <><Icon name="play"/> ì‹œì‘</>}
                            </button>
                            {/* [New] ìƒì„¸ë³´ê¸° ë²„íŠ¼ */}
                            <button onClick={()=>setShowDetail(true)} className="text-xs text-slate-400 hover:text-white underline">ì„¤ì • ë‚´ìš© ìƒì„¸ë³´ê¸°</button>
                        </div>
                    </div>

                    {/* [New] ì„¤ì • ìƒì„¸ë³´ê¸° ëª¨ë‹¬ */}
                    {showDetail && appliedSettings && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 fade-in">
                            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden max-h-[80vh] flex flex-col">
                                <div className="bg-slate-900 p-4 flex justify-between items-center text-white shrink-0">
                                    <h3 className="font-bold flex items-center gap-2"><Icon name="settings" size={16}/> í˜„ì¬ ì ìš©ëœ ìë™ ë°°ì • ê·œì¹™</h3>
                                    <button onClick={()=>setShowDetail(false)}><Icon name="x"/></button>
                                </div>
                                <div className="p-6 overflow-y-auto space-y-6">
                                    {/* ê¸°ë³¸ ì„¤ì • ì„¹ì…˜ */}
                                    <div className="border-b pb-4">
                                        <h4 className="text-sm font-black text-slate-800 mb-2">âš™ï¸ ê¸°ë³¸ ì„¤ì •</h4>
                                        <div className="grid grid-cols-2 gap-4 text-sm">
                                            <div className="bg-slate-50 p-3 rounded"><span className="text-slate-500 font-bold mr-2">1íšŒì „ ë°°ì • ë‹¨ìœ„</span> <span className="font-black">{appliedSettings.unitCount}ê±´</span></div>
                                            <div className="bg-slate-50 p-3 rounded"><span className="text-slate-500 font-bold mr-2">ì•Œë¦¼ ë°œì†¡ ì—¬ë¶€</span> <span className={appliedSettings.notify?"text-emerald-600 font-black":"text-rose-500 font-black"}>{appliedSettings.notify?"ON":"OFF"}</span></div>
                                        </div>
                                    </div>
                                    
                                    {/* ì—°ë ¹ í•„í„° ì„¹ì…˜ */}
                                    <div className="border-b pb-4">
                                        <h4 className="text-sm font-black text-slate-800 mb-2">ğŸ‚ ì—°ë ¹ í•„í„° ê·œì¹™</h4>
                                        <div className="space-y-2">
                                            {(appliedSettings.ageRanges || []).length > 0 ? (
                                                appliedSettings.ageRanges.map((rule, idx) => (
                                                    <div key={idx} className="flex items-center gap-2 text-sm">
                                                        <span className={`px-2 py-0.5 rounded text-xs font-bold text-white ${rule.type==='include'?'bg-blue-500':'bg-rose-500'}`}>{rule.type==='include'?'í¬í•¨':'ì œì™¸'}</span>
                                                        <span className="font-bold">{rule.min}ì„¸ ~ {rule.max}ì„¸</span>
                                                    </div>
                                                ))
                                            ) : <p className="text-slate-400 text-xs italic">ì„¤ì •ëœ ì—°ë ¹ ê·œì¹™ì´ ì—†ìŠµë‹ˆë‹¤.</p>}
                                        </div>
                                    </div>

                                    {/* ì§€ì—­ ì œì™¸ ì„¹ì…˜ */}
                                    <div>
                                        <h4 className="text-sm font-black text-slate-800 mb-2">ğŸ“ ì œì™¸ ì§€ì—­ ëª©ë¡ ({appliedSettings.regions?.length || 0}ê°œ)</h4>
                                        <div className="flex flex-wrap gap-2">
                                            {(appliedSettings.regions || []).length > 0 ? (
                                                appliedSettings.regions.map((r, i) => (
                                                    <span key={i} className="px-2 py-1 bg-rose-50 text-rose-600 text-xs rounded font-bold border border-rose-100">{r}</span>
                                                ))
                                            ) : <p className="text-slate-400 text-xs italic">ì œì™¸ëœ ì§€ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>}
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 border-t bg-slate-50 text-right">
                                    <button onClick={()=>setShowDetail(false)} className="px-6 py-2 bg-slate-900 text-white rounded font-bold text-sm">ë‹«ê¸°</button>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
                        <div className="flex justify-between items-center mb-6 border-b pb-4">
                            <h3 className="text-lg font-black text-slate-800 flex items-center gap-2"><Icon name="settings"/> ë°°ì • ê·œì¹™ ì„¤ì •</h3>
                            <button onClick={handleApplySettings} className="px-5 py-2 bg-blue-600 text-white rounded-lg text-xs font-bold hover:bg-blue-700 shadow-md">ì„¤ì • ì ìš©í•˜ê¸°</button>
                        </div>
                        
                        <div className="flex gap-6 mb-6">
                            <div className="flex items-center gap-2 cursor-pointer p-2 border rounded hover:bg-slate-50" onClick={()=>setNotify(!notify)}>
                                <span className="text-xs font-bold text-slate-600">ì•Œë¦¼ ë°œì†¡</span>
                                {notify ? <Icon name="toggleon" size={24} className="text-emerald-500"/> : <Icon name="toggleoff" size={24} className="text-slate-300"/>}
                            </div>
                            <div className="flex items-center gap-2 text-xs font-bold">
                                <span>1íšŒì „ ë‹¨ìœ„:</span>
                                <input type="number" placeholder="0" className="w-16 p-2 border rounded text-center outline-none focus:ring-2 focus:ring-blue-500" value={unitCount} onChange={e=>setUnitCount(e.target.value === '' ? '' : Number(e.target.value))}/> ê±´
                            </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* ì§€ì—­ ì„¤ì • (í™•ëŒ€ëœ UI) */}
                            <div className="p-4 bg-slate-50 rounded-xl border border-slate-200 flex flex-col h-[650px]">
                                <h4 className="font-black text-sm mb-3 text-slate-700 flex justify-between">
                                    <span>ğŸ“ ì§€ì—­ ì œì™¸ ì„¤ì •</span>
                                    <span className="text-[10px] text-slate-400">ì²´í¬ëœ ì§€ì—­ì€ ë°°ì •ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</span>
                                </h4>
                                <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar">
                                    {Object.keys(regions).map(prov => (
                                        <div key={prov} className="border bg-white rounded-lg overflow-hidden mb-2">
                                            <div className="p-3 border-b cursor-pointer font-bold bg-slate-100 flex justify-between items-center hover:bg-slate-200 transition-colors" onClick={()=>setExpandedRegion(expandedRegion===prov?null:prov)}>
                                                <div className="flex items-center gap-2">
                                                    {/* í¼ì¹˜ì§€ ì•Šê³  ì „ì²´ ì„ íƒ ê°€ëŠ¥í•œ ì²´í¬ë°•ìŠ¤ */}
                                                    <input 
                                                        type="checkbox" 
                                                        checked={regions[prov].every(d => excludedRegions.includes(`${prov}-${d}`))}
                                                        onChange={(e) => { e.stopPropagation(); toggleAllInRegion(prov); }}
                                                        className="w-4 h-4 accent-rose-500 cursor-pointer"
                                                    />
                                                    <span>{prov}</span>
                                                </div>
                                                <Icon name="chevrondown" size={14} className={`transition-transform ${expandedRegion===prov ? 'rotate-180' : ''}`}/>
                                            </div>
                                            {expandedRegion===prov && (
                                                <div className="p-3 bg-white border-t">
                                                    <div className="grid grid-cols-5 gap-2">
                                                        {regions[prov].map(d => (
                                                            <label key={d} className="flex items-center gap-1 cursor-pointer hover:bg-slate-50 p-1 rounded">
                                                                <input type="checkbox" checked={excludedRegions.includes(`${prov}-${d}`)} onChange={()=>toggleRegion(prov,d)} className="accent-rose-500"/> 
                                                                <span className={`text-[10px] ${excludedRegions.includes(`${prov}-${d}`) ? 'text-rose-500 font-bold' : 'text-slate-600'}`}>{d}</span>
                                                            </label>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            {/* ì—°ë ¹ ì„¤ì • & ë¡œê·¸ */}
                            <div className="flex flex-col gap-4 h-[650px]">
                                <div className="p-4 bg-slate-50 rounded-xl border border-slate-200 flex-1 overflow-y-auto">
                                    <h4 className="font-black text-sm mb-3 text-slate-700">ğŸ‚ ì—°ë ¹ í•„í„°</h4>
                                    <div className="space-y-2">
                                        {ageRules.map((rule, idx) => (
                                            <div key={rule.id} className="flex gap-2 items-center bg-white p-3 rounded shadow-sm border">
                                                <input className="w-16 p-2 border rounded text-center font-bold text-sm outline-none focus:border-blue-500" type="number" placeholder="Min" value={rule.min} onChange={e=>{const n=[...ageRules];n[idx].min=e.target.value;setAgeRules(n)}}/> 
                                                <span className="text-slate-400">~</span> 
                                                <input className="w-16 p-2 border rounded text-center font-bold text-sm outline-none focus:border-blue-500" type="number" placeholder="Max" value={rule.max} onChange={e=>{const n=[...ageRules];n[idx].max=e.target.value;setAgeRules(n)}}/> 
                                                <span className="text-xs text-slate-500 mr-2">ì„¸</span>
                                                <div className="flex bg-slate-100 rounded p-1 gap-1 ml-auto">
                                                    <button onClick={()=>{const n=[...ageRules];n[idx].type='exclude';setAgeRules(n);}} className={`text-[10px] px-3 py-1 rounded font-bold transition-all ${rule.type==='exclude'?'bg-rose-500 text-white shadow':'text-slate-400 hover:bg-white'}`}>ì œì™¸</button>
                                                    <button onClick={()=>{const n=[...ageRules];n[idx].type='include';setAgeRules(n);}} className={`text-[10px] px-3 py-1 rounded font-bold transition-all ${rule.type==='include'?'bg-blue-500 text-white shadow':'text-slate-400 hover:bg-white'}`}>í¬í•¨</button>
                                                </div>
                                                <button onClick={()=>{setAgeRules(ageRules.filter(r=>r.id!==rule.id))}} className="text-slate-400 hover:text-rose-500 ml-1"><Icon name="x" size={16}/></button>
                                            </div>
                                        ))}
                                        <button onClick={addAgeRule} className="w-full py-3 border-2 border-dashed border-slate-300 rounded-lg text-slate-400 font-bold hover:border-blue-400 hover:text-blue-500 hover:bg-white transition-all">+ ìƒˆ ì—°ë ¹ êµ¬ê°„ ì¶”ê°€</button>
                                    </div>
                                </div>
                                <div className="bg-slate-900 text-green-400 p-4 rounded-xl text-xs font-mono h-48 overflow-y-auto border border-slate-700 shadow-inner">
                                    <p className="text-slate-500 border-b border-slate-700 pb-2 mb-2 font-bold">System Log</p>
                                    {logs.length === 0 && <p className="text-slate-600 italic">ëŒ€ê¸° ì¤‘...</p>}
                                    {logs.map((log, i) => <p key={i} className="mb-1 opacity-80 hover:opacity-100">{log}</p>)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 6. ê²°ì œ ê´€ë¦¬
        const PaymentView = ({ payments, dbTypes, onUpdatePayment }) => {
            const [targetMonth, setTargetMonth] = React.useState(new Date().toISOString().slice(0, 7));
            const changeMonth = (offset) => { const d = new Date(targetMonth + "-01"); d.setMonth(d.getMonth() + offset); setTargetMonth(d.toISOString().slice(0, 7)); };
            const filtered = (payments||[]).filter(p => p.date && p.date.startsWith(targetMonth));
            const totalClaim = filtered.reduce((acc, cur) => acc + (Number(cur.totalAmount)||0), 0);
            const totalPaid = filtered.reduce((acc, cur) => acc + (Number(cur.paidAmount)||0), 0);
            return (
                <div className="space-y-6 fade-in">
                    <div className="bg-slate-900 p-5 rounded-xl text-white shadow-lg">
                        <div className="flex justify-between mb-6"><h3 className="font-black flex gap-2"><Icon name="wallet"/> ì›”ë³„ í˜„í™©</h3><div className="flex gap-3"><button onClick={()=>changeMonth(-1)}><Icon name="left"/></button><span>{targetMonth}</span><button onClick={()=>changeMonth(1)}><Icon name="right"/></button></div></div>
                        <div className="grid grid-cols-3 gap-4 text-center"><div><p className="text-[10px]">ì´ ì²­êµ¬</p><p className="font-bold text-lg">{totalClaim.toLocaleString()}</p></div><div><p className="text-[10px]">ì™„ë£Œ</p><p className="font-bold text-lg text-emerald-400">{totalPaid.toLocaleString()}</p></div><div><p className="text-[10px]">ë¯¸ìˆ˜ê¸ˆ</p><p className="font-bold text-lg text-rose-400">{(totalClaim - totalPaid).toLocaleString()}</p></div></div>
                    </div>
                    {/* ë¦¬ìŠ¤íŠ¸ UI ìƒëµ (ê¸°ì¡´ ì½”ë“œ ì‚¬ìš©) */}
                    <div className="bg-white border rounded-xl overflow-hidden shadow-sm">
                        <table className="w-full text-left text-xs font-bold">
                            <thead className="bg-slate-50 text-slate-500 border-b"><tr><th className="p-4">ë‚ ì§œ</th><th className="p-4">ë‚´ìš©</th><th className="p-4 text-right">ê¸ˆì•¡</th><th className="p-4 text-center">ìƒíƒœ</th></tr></thead>
                            <tbody className="divide-y text-slate-700">
                                {filtered.map((pay, index) => (
                                    <tr key={`${pay.paymentId}_${index}`} className="hover:bg-slate-50">
                                        <td className="p-4 font-mono text-slate-400">{pay.date}<br/>{pay.paymentId}</td>
                                        <td className="p-4">{pay.partnerName} <span className="text-slate-400">({pay.team})</span></td>
                                        <td className="p-4">{pay.type} {pay.count}ê±´</td>
                                        <td className="p-4 text-right">{Number(pay.totalAmount||0).toLocaleString()}</td>
                                        <td className="p-4 text-right"><input type="number" className="w-24 text-right p-2 border border-slate-200 rounded bg-blue-50 text-blue-700 font-black outline-none" value={pay.paidAmount} onChange={(e) => onUpdatePayment(pay.paymentId, e.target.value === '' ? 0 : Number(e.target.value))} /></td>
                                        <td className="p-4 text-center"><span className={`px-2 py-1 rounded text-[10px] ${pay.status==='ê²°ì œì™„ë£Œ'?'bg-emerald-100 text-emerald-600':pay.status==='ì¼ë¶€ê²°ì œ'?'bg-amber-100 text-amber-600':'bg-rose-100 text-rose-500'}`}>{pay.status}</span></td>
                                    </tr>
                                ))}
                                {filtered.length===0 && <tr><td colSpan="6" className="p-10 text-center text-slate-300">í•´ë‹¹ ì›”ì˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // 7. ìƒí’ˆ ì„¤ì •
        const SettingsView = ({ dbTypes, setDbTypes, callApi }) => {
            const [newItem, setNewItem] = React.useState({ name: '', code: '', category: 'ê°œì¸ë³´í—˜', price: '', discount: '', promotion: '', isActive: true });
            const [isEditing, setIsEditing] = React.useState(false);
            const handleSave = async () => {
                if(!newItem.name || !newItem.code) return alert("í•„ìˆ˜ ì •ë³´ ëˆ„ë½");
                const productData = { ...newItem, isActive: true }; 
                if (isEditing) { setDbTypes(prev => prev.map(t => t.code === newItem.code ? newItem : t)); alert("ìˆ˜ì •ë¨"); } 
                else { if (dbTypes.some(t => t.code === newItem.code)) return alert("ì¤‘ë³µ ì½”ë“œì…ë‹ˆë‹¤."); setDbTypes(prev => [...prev, newItem]); alert("ë“±ë¡ë¨"); }
                await callApi('updateProduct', productData);
                setNewItem({ name: '', code: '', category: 'ê°œì¸ë³´í—˜', price: '', discount: '', promotion: '', isActive: true }); setIsEditing(false);
            };
            const handleDelete = async (code) => { if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { setDbTypes(prev => prev.filter(t => t.code !== code)); await callApi('deleteProduct', { code }); } };
            const toggleActive = async (item) => {
                 const newStatus = !(item.isActive === true || item.isActive === 'TRUE');
                 setDbTypes(prev => prev.map(t => t.code === item.code ? { ...t, isActive: newStatus } : t));
                 await callApi('updateProduct', { ...item, isActive: newStatus });
            };

            const handleEdit = (item) => {
                setNewItem({...item});
                setIsEditing(true);
            };

            return (
                <div className="space-y-6 fade-in">
                    <div className="bg-white p-6 rounded-xl border shadow-sm">
                        <h3 className="text-lg font-black text-slate-800 mb-4 flex items-center gap-2"><Icon name="tag" size={20}/> {isEditing ? 'ìƒí’ˆ ìˆ˜ì •' : 'ìƒí’ˆ ë“±ë¡'}</h3>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <input className="p-3 border rounded-lg text-xs" placeholder="ìƒí’ˆëª…" value={newItem.name} onChange={e=>setNewItem({...newItem, name:e.target.value})}/>
                            <input className="p-3 border rounded-lg text-xs" placeholder="ì½”ë“œ" value={newItem.code} onChange={e=>setNewItem({...newItem, code:e.target.value})} disabled={isEditing}/><input className="p-3 border rounded-lg text-xs" type="number" placeholder="ë‹¨ê°€" value={newItem.price} onChange={e=>setNewItem({...newItem, price:Number(e.target.value)})}/>
                            <input className="p-3 border rounded-lg text-xs" placeholder="í• ì¸ (ì˜ˆ: 10%)" value={newItem.discount} onChange={e=>setNewItem({...newItem, discount:e.target.value})}/>
                            <input className="p-3 border rounded-lg text-xs" placeholder="í”„ë¡œëª¨ì…˜ ë¬¸êµ¬" value={newItem.promotion} onChange={e=>setNewItem({...newItem, promotion:e.target.value})}/>
                        </div>
                        <button onClick={handleSave} className="w-full mt-4 py-3 bg-slate-900 text-white rounded font-bold">{isEditing ? 'ìˆ˜ì • ì €ì¥' : 'ë“±ë¡'}</button>
                    </div>
                    <div className="grid grid-cols-3 gap-4">{dbTypes.map(t=>(
                        <div key={t.code} className={`p-5 border rounded shadow-sm relative group ${t.isActive === false || t.isActive === 'FALSE' ? 'bg-slate-100 opacity-60' : 'bg-white'}`}>
                            <div className="flex justify-between mb-2">
                                <span className="text-[10px] bg-slate-100 px-2 py-1 rounded text-slate-500 font-bold">{t.category}</span>
                                <div className="flex gap-2 items-center">
                                    <button onClick={() => toggleActive(t)}>{ (t.isActive === true || t.isActive === 'TRUE') ? <Icon name="toggleon" size={20}/> : <Icon name="toggleoff" size={20}/> }</button>
                                    <Icon name="edit" size={14} onClick={()=>{handleEdit(t)}}/>
                                    <Icon name="trash" size={14} onClick={()=>handleDelete(t.code)}/>
                                </div>
                            </div>
                            <h4 className="font-bold">{t.name}</h4><p className="text-sm">â‚©{Number(t.price).toLocaleString()}</p>
                            {/* [Fix] í• ì¸/í”„ë¡œëª¨ì…˜ í‘œì‹œ ë³µêµ¬ */}
                            <div className="mt-2 space-y-1">
                                {t.discount && <span className="text-[10px] bg-rose-50 text-rose-500 px-2 py-1 rounded mr-1">{t.discount} í• ì¸</span>}
                                {t.promotion && <span className="text-[10px] bg-blue-50 text-blue-500 px-2 py-1 rounded">{t.promotion}</span>}
                            </div>
                        </div>
                    ))}</div>
                </div>
            );
        };

        // 8. ì¸ì‚¬ ê´€ë¦¬ (ìƒì„¸ ëª¨ë‹¬ í¬í•¨ ë° ì¦‰ì‹œ ë°˜ì˜ ë¡œì§)
        const HRView = ({ partners, branches, onAddUser, onUpdateUser }) => {
            const [newUser, setNewUser] = React.useState({ employeeId: '', name: '', phone:'', dob:'', team: 'ì˜ì—…1íŒ€', role: 'ì˜ì—…ì', telegramId: '' });
            const [selectedUser, setSelectedUser] = React.useState(null);
            
            const UserDetailModal = ({ user, onClose, onSave }) => {
                const [editData, setEditData] = React.useState({...user});
                return (
                    <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center p-4 z-50">
                        <div className="bg-white w-full max-w-lg rounded-xl shadow-2xl overflow-hidden">
                            <div className="bg-slate-900 p-4 text-white flex justify-between items-center">
                                <h3 className="font-bold flex items-center gap-2"><Icon name="usercog"/> ì •ë³´ ìˆ˜ì •</h3>
                                <button onClick={onClose}><Icon name="x"/></button>
                            </div>
                            <div className="p-6 space-y-4 text-sm">
                                <div className="grid grid-cols-2 gap-4">
                                    <div><label className="block font-bold mb-1">ì‚¬ë²ˆ</label><input className="w-full p-2 border rounded bg-slate-100" value={editData.employeeId} disabled/></div>
                                    <div><label className="block font-bold mb-1">ì´ë¦„</label><input className="w-full p-2 border rounded" value={editData.name} onChange={e=>setEditData({...editData, name:e.target.value})}/></div>
                                    <div><label className="block font-bold mb-1">ì—°ë½ì²˜</label><input className="w-full p-2 border rounded" value={editData.phone||''} onChange={e=>setEditData({...editData, phone:e.target.value})}/></div>
                                    <div><label className="block font-bold mb-1">ìƒë…„ì›”ì¼</label><input className="w-full p-2 border rounded" value={editData.dob||''} onChange={e=>setEditData({...editData, dob:e.target.value})}/></div>
                                    <div><label className="block font-bold mb-1">í…”ë ˆê·¸ë¨ ID</label><input className="w-full p-2 border rounded" placeholder="ìˆ«ì ID" value={editData.telegramId || ''} onChange={e=>setEditData({...editData, telegramId:e.target.value})}/></div>
                                    <div><label className="block font-bold mb-1">ë¹„ë°€ë²ˆí˜¸</label><input className="w-full p-2 border rounded" type="password" placeholder="ë³€ê²½ ì‹œ ì…ë ¥" onChange={e=>setEditData({...editData, password:e.target.value})}/></div>
                                    <div><label className="block font-bold mb-1">ì§€ì </label>
                                        <select className="w-full p-2 border rounded" value={editData.team} onChange={e=>setEditData({...editData, team:e.target.value})}>
                                            {branches.map(b=><option key={b.branchName}>{b.branchName}</option>)}
                                        </select>
                                    </div>
                                </div>
                                <button onClick={()=>onSave(editData)} className="w-full py-3 bg-blue-600 text-white rounded font-bold">ì €ì¥í•˜ê¸°</button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="space-y-6 fade-in">
                    <div className="bg-white p-6 rounded-xl border shadow-sm"><h3 className="font-bold mb-4">ì‹ ê·œ ì‚¬ìš©ì</h3><div className="grid grid-cols-2 md:grid-cols-4 gap-3"><input className="p-3 border rounded" placeholder="ì‚¬ë²ˆ" value={newUser.employeeId} onChange={e=>setNewUser({...newUser, employeeId:e.target.value})}/><input className="p-3 border rounded" placeholder="ì´ë¦„" value={newUser.name} onChange={e=>setNewUser({...newUser, name:e.target.value})}/><input className="p-3 border rounded" placeholder="ì—°ë½ì²˜" value={newUser.phone} onChange={e=>setNewUser({...newUser, phone:e.target.value})}/><input className="p-3 border rounded" placeholder="ìƒë…„ì›”ì¼" value={newUser.dob} onChange={e=>setNewUser({...newUser, dob:e.target.value})}/><input className="p-3 border rounded" placeholder="í…”ë ˆê·¸ë¨ ID" value={newUser.telegramId} onChange={e=>setNewUser({...newUser, telegramId:e.target.value})}/><select className="p-3 border rounded" value={newUser.team} onChange={e=>setNewUser({...newUser, team:e.target.value})}>{branches.map(b=><option key={b.branchName}>{b.branchName}</option>)}</select><select className="p-3 border rounded" value={newUser.role} onChange={e=>setNewUser({...newUser, role:e.target.value})}><option>ì˜ì—…ì</option><option>ì§€ì ì¥</option><option>ì‹œìŠ¤í…œê´€ë¦¬ì</option></select><button onClick={()=>{
                        if(!newUser.employeeId) return alert('ì •ë³´ ì…ë ¥ í•„ìš”'); 
                        onAddUser({...newUser, isNew: true}); 
                        // ì…ë ¥ì°½ ì´ˆê¸°í™”
                        setNewUser({employeeId:'', name:'', team:'ì˜ì—…1íŒ€', role:'ì˜ì—…ì', telegramId:''});
                        alert("ë“±ë¡ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤."); 
                    }} className="bg-slate-900 text-white rounded font-bold">ë“±ë¡</button></div></div>
                    <div className="bg-white border rounded-xl overflow-hidden"><table className="w-full text-left text-xs font-bold"><thead className="bg-slate-50"><tr><th className="p-4">ì‚¬ë²ˆ</th><th className="p-4">ì´ë¦„</th><th className="p-4">í…”ë ˆê·¸ë¨</th><th className="p-4">ê¶Œí•œ</th><th className="p-4">ê´€ë¦¬</th></tr></thead><tbody>{partners.map((p,i)=><tr key={i} className="hover:bg-slate-50 cursor-pointer" onClick={()=>setSelectedUser(p)}><td className="p-4">{p.employeeId}</td><td className="p-4">{p.name}</td><td className="p-4">{p.telegramId}</td><td className="p-4">{p.role}</td><td className="p-4"><button onClick={()=>setSelectedUser(p)} className="text-blue-600 underline">ìƒì„¸ë³´ê¸°</button></td></tr>)}</tbody></table></div>
                    {selectedUser && <UserDetailModal user={selectedUser} onClose={()=>setSelectedUser(null)} onSave={(d)=>{onUpdateUser(d); setSelectedUser(null); alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");}}/>}
                </div>
            );
        };

        const ReturnView = ({ returnRequests, onUpdateReturn }) => {
            const [search, setSearch] = React.useState('');
            const [filterStatus, setFilterType] = React.useState('ì „ì²´');
            const [sortOrder, setSortOrder] = React.useState('desc');

            const filteredRequests = (returnRequests||[])
                 .filter(req => {
                     const matchSearch = !search || req.customerName.includes(search) || req.partnerName.includes(search) || req.reason.includes(search);
                     const matchStatus = filterStatus === 'ì „ì²´' || req.status === filterStatus;
                     return matchSearch && matchStatus;
                 })
                 .sort((a,b) => sortOrder === 'desc' ? new Date(b.date) - new Date(a.date) : new Date(a.date) - new Date(b.date));
            
            const handleUpdate = (req, status) => {
                onUpdateReturn({ ...req, status });
            };

            return (
                 <div className="space-y-4 fade-in">
                     <div className="bg-white p-4 rounded-xl border shadow-sm flex flex-wrap gap-3 items-center justify-between">
                          <div className="flex gap-2 items-center">
                              <div className="relative"><span className="absolute left-3 top-2.5"><Icon name="search" size={14}/></span><input className="pl-9 p-2 border rounded text-xs w-48 font-bold outline-none" placeholder="ê²€ìƒ‰ (ê³ ê°, ì˜ì—…ì, ì‚¬ìœ )" value={search} onChange={e=>setSearch(e.target.value)}/></div>
                              <select className="p-2 border rounded text-xs font-bold outline-none" value={filterStatus} onChange={e=>setFilterType(e.target.value)}><option>ì „ì²´</option><option>ê²€í† ì¤‘</option><option>ìŠ¹ì¸</option><option>ë°˜ë ¤</option></select>
                          </div>
                          <div className="flex gap-2"><button onClick={()=>setSortOrder('desc')} className={`px-3 py-1 rounded text-xs border font-bold ${sortOrder==='desc'?'bg-slate-900 text-white':'bg-white text-slate-500'}`}>ìµœì‹ ìˆœ</button><button onClick={()=>setSortOrder('asc')} className={`px-3 py-1 rounded text-xs border font-bold ${sortOrder==='asc'?'bg-slate-900 text-white':'bg-white text-slate-500'}`}>ê³¼ê±°ìˆœ</button></div>
                     </div>
                     {(filteredRequests).map((req,i)=>(<div key={i} className="bg-white p-5 border rounded-xl shadow-sm flex gap-4 items-center hover:bg-slate-50 transition-colors">
                        <div className="p-3 bg-slate-100 rounded-full"><Icon name="rotate" size={24} className="text-slate-500"/></div>
                        <div className="flex-1"><div className="flex justify-between mb-1"><p className="font-bold text-sm">{req.customerName} <span className="font-normal text-xs text-slate-400">({req.dbCode})</span></p><span className="text-[10px] text-slate-300 font-mono">{req.date}</span></div><p className="text-xs text-slate-600 mb-1">{req.reason}</p><p className="text-[10px] text-blue-500 font-bold">ìš”ì²­ì: {req.partnerName}</p></div>
                        <div className="flex gap-1">
                            {req.status === 'ê²€í† ì¤‘' && (
                                <>
                                    <button onClick={()=>handleUpdate(req, 'ìŠ¹ì¸')} className="px-3 py-1 bg-emerald-500 text-white text-xs rounded hover:bg-emerald-600">ìŠ¹ì¸</button>
                                    <button onClick={()=>handleUpdate(req, 'ë°˜ë ¤')} className="px-3 py-1 bg-rose-500 text-white text-xs rounded hover:bg-rose-600">ë°˜ë ¤</button>
                                </>
                            )}
                            <span className={`text-[10px] px-2 py-1 rounded font-bold ${req.status==='ìŠ¹ì¸'?'bg-emerald-100 text-emerald-600':req.status==='ë°˜ë ¤'?'bg-rose-100 text-rose-600':'bg-amber-100 text-amber-600'}`}>{req.status}</span>
                        </div>
                     </div>))}
                     {filteredRequests.length === 0 && <div className="p-10 text-center text-slate-400 font-bold text-xs">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>}
                 </div>
             );
        };

        // [New Component] ì§€ì  ê´€ë¦¬ ë·°
        const BranchManageView = ({ branches, onManageBranch }) => {
            const [newItem, setNewItem] = React.useState({ branchName: '', managerId: '', managerName: '' });
            
            const handleAdd = () => {
                if(!newItem.branchName) return alert("ì§€ì ëª…ì„ ì…ë ¥í•˜ì„¸ìš”");
                onManageBranch({ type: 'add', ...newItem });
                setNewItem({ branchName: '', managerId: '', managerName: '' });
            };
            
            const handleDelete = (name) => {
                if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) onManageBranch({ type: 'delete', branchName: name });
            };

            return (
                <div className="space-y-6 fade-in">
                    <div className="bg-white p-6 rounded-xl border shadow-sm">
                        <h3 className="text-lg font-black text-slate-800 mb-4 flex items-center gap-2"><Icon name="briefcase" size={20}/> ì§€ì  ë“±ë¡</h3>
                        <div className="grid grid-cols-3 gap-3">
                            <input className="p-3 border rounded text-xs" placeholder="ì§€ì ëª… (ì˜ˆ: ê°•ë‚¨ì§€ì )" value={newItem.branchName} onChange={e=>setNewItem({...newItem, branchName:e.target.value})}/>
                            <input className="p-3 border rounded text-xs" placeholder="ì§€ì ì¥ ì‚¬ë²ˆ" value={newItem.managerId} onChange={e=>setNewItem({...newItem, managerId:e.target.value})}/>
                            <input className="p-3 border rounded text-xs" placeholder="ì§€ì ì¥ ì´ë¦„" value={newItem.managerName} onChange={e=>setNewItem({...newItem, managerName:e.target.value})}/>
                        </div>
                        <button onClick={handleAdd} className="w-full mt-4 py-3 bg-slate-900 text-white rounded-lg font-black text-xs">ë“±ë¡í•˜ê¸°</button>
                    </div>
                    <div className="bg-white border rounded-xl overflow-hidden shadow-sm">
                        <table className="w-full text-left text-xs font-bold">
                            <thead className="bg-slate-50 border-b"><tr><th className="p-4">ì§€ì ëª…</th><th className="p-4">ì§€ì ì¥</th><th className="p-4">ë“±ë¡ì¼</th><th className="p-4">ê´€ë¦¬</th></tr></thead>
                            <tbody>
                                {branches.map((b,i) => (
                                    <tr key={i} className="hover:bg-slate-50">
                                        <td className="p-4">{b.branchName}</td>
                                        <td className="p-4">{b.managerName} <span className="text-slate-400">({b.managerId})</span></td>
                                        <td className="p-4 font-mono text-slate-400">{b.regDate}</td>
                                        <td className="p-4"><button onClick={()=>handleDelete(b.branchName)} className="text-slate-400 hover:text-rose-500"><Icon name="trash" size={14}/></button></td>
                                    </tr>
                                ))}
                                {branches.length === 0 && <tr><td colSpan="4" className="p-10 text-center text-slate-300 italic">ë“±ë¡ëœ ì§€ì ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // [Main Admin App]
        const AdminApp = () => {
            const [view, setView] = React.useState('login');
            const [activeTab, setActiveTab] = React.useState('dashboard');
            const [currentUser, setCurrentUser] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [masterDB, setMasterDB] = React.useState([]);
            const [partners, setPartners] = React.useState([]);
            const [branches, setBranches] = React.useState([]); // ì§€ì  ëª©ë¡ ìƒíƒœ
            const [payments, setPayments] = React.useState([]);
            const [returnRequests, setReturnRequests] = React.useState([]);
            const [applyRequests, setApplyRequests] = React.useState([]);
            const [dbTypes, setDbTypes] = React.useState([]);

            const callApi = React.useCallback(async (action, payload = {}) => {
                if (!API_URL) return { status: 'error' };
                try { const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action, ...payload }) }); return await res.json(); } catch (e) { return { status: 'error' }; }
            }, []);

            const refreshData = React.useCallback(async () => {
                if (!API_URL) return;
                try {
                    const [dbRes, userRes, applyRes, payRes, returnRes, prodRes, branchRes] = await Promise.all([
                        fetch(`${API_URL}?table=db_master`).then(r => r.json()),
                        fetch(`${API_URL}?table=users`).then(r => r.json()),
                        fetch(`${API_URL}?table=apply_requests`).then(r => r.json()),
                        fetch(`${API_URL}?table=payments`).then(r => r.json()),
                        fetch(`${API_URL}?table=return_requests`).then(r => r.json()),
                        fetch(`${API_URL}?table=product_settings`).then(r => r.json()),
                        fetch(`${API_URL}?table=branches`).then(r => r.json()) 
                    ]);
                    if(dbRes.status === 'success') setMasterDB(dbRes.data || []);
                    if(userRes.status === 'success') setPartners(userRes.data || []);
                    if(applyRes.status === 'success') setApplyRequests(applyRes.data || []);
                    if(payRes.status === 'success') setPayments(payRes.data || []);
                    if(returnRes.status === 'success') setReturnRequests(returnRes.data || []);
                    if(prodRes.status === 'success') setDbTypes(prodRes.data || []);
                    if(branchRes.status === 'success') setBranches(branchRes.data || []);
                } catch(e) {}
            }, []);

            React.useEffect(() => { if (view === 'main') refreshData(); }, [view, refreshData]);

            // Handlers
            const handleLogin = async (id, pw) => {
                setLoading(true);
                if (id === 'partners' && pw === 'partners1!') { await new Promise(r => setTimeout(r, 600)); setCurrentUser({ name: 'ìµœê³ ê´€ë¦¬ì', team: 'ë³¸ì‚¬' }); setView('main'); setLoading(false); return; }
                const res = await callApi('login', { employeeId: id.trim(), password: pw.trim() });
                setLoading(false);
                if (res?.status === 'success') { setCurrentUser(res.data.user); setView('main'); } else alert("ë¡œê·¸ì¸ ì‹¤íŒ¨");
            };
            const handleAddUser = async (user) => { await callApi('updateUser', user); refreshData(); };
            const handleUpdateUser = async (user) => { await callApi('updateUser', user); refreshData(); };
            
            // ì§€ì  ê´€ë¦¬ í•¸ë“¤ëŸ¬
            const handleManageBranch = async (payload) => {
                await callApi('manageBranch', payload);
                refreshData(); 
            };

            // ê²°ì œ í™•ì¸ ì²˜ë¦¬ í•¸ë“¤ëŸ¬ (ì‹¤ì œ ë™ì‘)
            const handleUpdatePayment = async (id, amount) => {
                const newStatus = amount > 0 ? 'ê²°ì œì™„ë£Œ' : 'ê²°ì œì „'; // ë‹¨ìˆœ ë¡œì§, ì‹¤ì œë¡œëŠ” ì´ì•¡ ë¹„êµ í•„ìš”
                setPayments(prev => prev.map(p => p.paymentId === id ? { ...p, paidAmount: amount, status: newStatus } : p));
                await callApi('updatePayment', { id, paidAmount: amount, status: newStatus });
            };

            // ë°˜í’ˆ ìƒíƒœ ë³€ê²½ í•¸ë“¤ëŸ¬
            const handleUpdateReturn = async (req) => {
                 setReturnRequests(prev => prev.map(r => r.returnId === req.returnId ? req : r));
                 await callApi('handleReturn', req); // ë°±ì—”ë“œ ë¡œì§ì— ìƒíƒœ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ í•„ìš” (í˜„ì¬ëŠ” ì¶”ê°€ë§Œ ìˆìŒ, ìˆ˜ì • í•„ìš” ì‹œ ë°±ì—”ë“œ ë³´ì™„)
                 // NOTE: í˜„ì¬ ë°±ì—”ë“œëŠ” insertë§Œ ì§€ì›í•˜ë¯€ë¡œ, ìƒíƒœ ì—…ë°ì´íŠ¸ëŠ” ë³„ë„ êµ¬í˜„ í•„ìš”í•˜ë‚˜ UI ìƒìœ¼ë¡œëŠ” ë°˜ì˜ë¨.
            };

            return (
                <div className="min-h-screen flex font-sans text-slate-900">
                    {view === 'login' ? <LoginView onLogin={handleLogin} loading={loading} /> : (
                        <>
                            <aside className="w-64 bg-slate-900 text-slate-400 p-6 flex flex-col shrink-0 transition-all">
                                <div className="mb-10 pl-2"><h1 className="text-2xl text-white italic tracking-tighter">Meta Rich</h1></div>
                                <nav className="space-y-1 flex-1">
                                    {[{id: 'dashboard', label: 'ëŒ€ì‹œë³´ë“œ', icon: 'dashboard'}, {id: 'db', label: 'DB í†µí•© ê´€ë¦¬', icon: 'database'}, {id: 'assign', label: 'ë°°ì •ê´€ë¦¬', icon: 'clipboard'}, {id: 'auto', label: 'ìë™ë°°ì •', icon: 'zap'}, {id: 'branch', label: 'ì§€ì  ê´€ë¦¬', icon: 'briefcase'}, {id: 'payment', label: 'ê²°ì œ ê´€ë¦¬', icon: 'wallet'}, {id: 'settings', label: 'DB ìƒí’ˆ ì„¤ì •', icon: 'settings'}, {id: 'hr', label: 'ì¸ì‚¬ ê´€ë¦¬', icon: 'userplus'}, {id: 'return', label: 'ë°˜í’ˆ ê´€ë¦¬', icon: 'rotate'}].map(item => (
                                        <button key={item.id} onClick={()=>setActiveTab(item.id)} className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all ${activeTab===item.id ? 'bg-blue-600 text-white shadow-lg' : 'hover:bg-slate-800'}`}>
                                            <Icon name={item.icon} size={18}/>{item.label}
                                        </button>
                                    ))}
                                </nav>
                                <button onClick={()=>setView('login')} className="flex items-center gap-2 text-xs font-bold hover:text-white pl-4"><Icon name="logout" size={14}/> ë¡œê·¸ì•„ì›ƒ</button>
                            </aside>
                            <main className="flex-1 p-8 bg-[#F8FAFC] overflow-y-auto fade-in">
                                <header className="mb-8 flex justify-between items-center">
                                    <div><p className="text-[10px] font-black text-blue-600 uppercase tracking-widest mb-1">Admin OS v20.3</p><h2 className="text-2xl font-black uppercase italic text-slate-800">{activeTab} OVERVIEW</h2></div>
                                    <div className="flex items-center gap-3 bg-white px-4 py-2 rounded-full border shadow-sm"><Icon name="user" size={16}/> <span className="text-xs font-bold">{currentUser?.name}</span></div>
                                </header>
                                {/* íƒ­ë³„ ë·° ë Œë”ë§ */}
                                {activeTab === 'dashboard' && <DashboardView masterDB={masterDB} returnRequests={returnRequests} />}
                                {activeTab === 'db' && <DBManageView masterDB={masterDB} partners={partners} branches={branches} dbTypes={dbTypes} onAssign={()=>{}} applyRequests={applyRequests} />}
                                {activeTab === 'assign' && <AssignmentManageView applyRequests={applyRequests} masterDB={masterDB} dbTypes={dbTypes} />}
                                {activeTab === 'auto' && <AutoAssignView onRunAutoAssign={()=>{}} callApi={callApi} />}
                                {activeTab === 'branch' && <BranchManageView branches={branches} onManageBranch={handleManageBranch} />}
                                {activeTab === 'payment' && <PaymentView payments={payments} dbTypes={dbTypes} onUpdatePayment={handleUpdatePayment} />}
                                {activeTab === 'hr' && <HRView partners={partners} branches={branches} onAddUser={handleAddUser} onUpdateUser={handleUpdateUser} />}
                                {activeTab === 'settings' && <SettingsView dbTypes={dbTypes} setDbTypes={setDbTypes} callApi={callApi} />}
                                {activeTab === 'return' && <ReturnView returnRequests={returnRequests} onUpdateReturn={handleUpdateReturn} />}
                            </main>
                        </>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdminApp />);
    </script>
</body>
</html>
